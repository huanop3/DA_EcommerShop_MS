@page "/profile"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using BlazorWebApp.Services
@using MainEcommerceService.Models.ViewModel
@using MainEcommerceService.Models.dbMainEcommer
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserService UserService
@inject AddressService AddressService
@inject SellerProfileService SellerProfileService
@inject ToastService ToastService
@inject SignalRService SignalRService
@inject IJSRuntime JSRuntime
@attribute [Authorize]
@implements IDisposable

<PageTitle>My Profile - Grabit</PageTitle>
<link href="css/profile.css" rel="stylesheet" />
<div class="container">
@if (isLoading)
{
    <div class="loading-indicator" style="text-align: center; padding: 50px;">
        <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
        <div class="loading-text">Loading profile...</div>
    </div>
}
else if (currentUser != null)
{
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-avatar-section">
            <div class="avatar-upload">
                <div class="profile-avatar">@GetInitials(currentUser)</div>
                <div class="avatar-upload-overlay" @onclick="OpenAvatarUpload">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <div class="profile-info">
                <h1>@GetFullName(currentUser)</h1>
                <div class="username">@@@currentUser.UserName</div>
                <div class="join-date">
                    <i class="fas fa-calendar-alt"></i>
                    Member since @DateTime.Now.ToString("MMMM yyyy")
                </div>
                @if (currentSellerProfile != null)
                {
                    <div class="seller-badge">
                        <i class="fas fa-store"></i>
                        @if (currentSellerProfile.IsVerified == true)
                        {
                            <span class="verified-seller">Verified Seller</span>
                        }
                        else
                        {
                            <span class="pending-seller">Seller (Pending Verification)</span>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Profile Cards Grid -->
    <div class="profile-cards">
        <!-- Personal Information Card -->
        <div class="profile-card">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-user"></i></div>
                <h3 class="card-title">Personal Information</h3>
            </div>
            <EditForm Model="@editModel" OnValidSubmit="@UpdateProfile">
                <DataAnnotationsValidator />
                
                <div class="form-group">
                    <label>First Name</label>
                    <InputText @bind-Value="editModel.FirstName" class="form-control" disabled="@(!isEditing)" />
                    <ValidationMessage For="@(() => editModel.FirstName)" />
                </div>
                
                <div class="form-group">
                    <label>Last Name</label>
                    <InputText @bind-Value="editModel.LastName" class="form-control" disabled="@(!isEditing)" />
                    <ValidationMessage For="@(() => editModel.LastName)" />
                </div>
                
                <div class="form-group">
                    <label>Username</label>
                    <InputText @bind-Value="editModel.UserName" class="form-control" disabled="true" />
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <InputText @bind-Value="editModel.Email" class="form-control" disabled="true" />
                </div>
                
                <div class="form-group">
                    <label>Phone Number</label>
                    <InputText @bind-Value="editModel.PhoneNumber" class="form-control" disabled="@(!isEditing)" />
                    <ValidationMessage For="@(() => editModel.PhoneNumber)" />
                </div>

                @if (!isEditing)
                {
                    <button type="button" class="btn btn-primary" @onclick="StartEdit">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                }
                else
                {
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="loading-spinner"></span>
                            }
                            else
                            {
                                <i class="fas fa-save"></i>
                            }
                            Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                }
            </EditForm>
        </div>
        <!-- Seller Profile Card -->
        <AuthorizeView Roles="Seller,Customer">
                <Authorized>
<div class="profile-card">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-store"></i></div>
                <h3 class="card-title">Seller Profile</h3>
            </div>
            
            @if (currentSellerProfile == null)
            {
                <!-- Become a Seller Section -->
                <div class="become-seller-section">
                    <div class="seller-info">
                        <i class="fas fa-rocket seller-icon"></i>
                        <h4>Become a Seller</h4>
                        <p>Start selling your products on our platform and reach thousands of customers!</p>
                        
                        <div class="seller-benefits">
                            <div class="benefit-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Create your own store</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Manage your products</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Track sales & earnings</span>
                            </div>
                            <div class="benefit-item">
                                <i class="fas fa-check-circle"></i>
                                <span>24/7 seller support</span>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-become-seller" @onclick="OpenSellerRegistrationModal">
                        <i class="fas fa-store"></i> Become a Seller
                    </button>
                </div>
            }
            else
            {
                <!-- Existing Seller Profile Section -->
                <div class="seller-profile-info">
                    <div class="seller-status">
                        @if (currentSellerProfile.IsVerified == true)
                        {
                            <div class="status-badge verified">
                                <i class="fas fa-check-circle"></i>
                                Verified Seller
                            </div>
                        }
                        else
                        {
                            <div class="status-badge pending">
                                <i class="fas fa-clock"></i>
                                Pending Verification
                            </div>
                        }
                    </div>
                    
                    <div class="seller-details">
                        <div class="detail-item">
                            <label>Store Name:</label>
                            <span class="store-name">@currentSellerProfile.StoreName</span>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(currentSellerProfile.Description))
                        {
                            <div class="detail-item">
                                <label>Description:</label>
                                <p class="store-description">@currentSellerProfile.Description</p>
                            </div>
                        }
                        
                        <div class="detail-item">
                            <label>Registration Date:</label>
                            <span>@(currentSellerProfile.CreatedAt?.ToString("MMMM dd, yyyy") ?? "Unknown")</span>
                        </div>
                        
                        @if (currentSellerProfile.UpdatedAt.HasValue)
                        {
                            <div class="detail-item">
                                <label>Last Updated:</label>
                                <span>@currentSellerProfile.UpdatedAt.Value.ToString("MMMM dd, yyyy")</span>
                            </div>
                        }
                    </div>
                    
                    <div class="seller-actions">
                        <button type="button" class="btn btn-secondary" @onclick="EditSellerProfile">
                            <i class="fas fa-edit"></i> Edit Store Info
                        </button>
                        
                        @if (currentSellerProfile.IsVerified != true)
                        {
                            <div class="verification-info">
                                <i class="fas fa-info-circle"></i>
                                <span>Your seller profile is under review. You'll be notified once it's verified.</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
                </Authorized>
            </AuthorizeView>
        

        <!-- Account Statistics -->
        <div class="profile-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3 class="card-title">Account Statistics</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number">@userStats.TotalOrders</span>
                    <span class="stat-label">Total Orders</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@userStats.TotalSpent.ToString("C")</span>
                    <span class="stat-label">Total Spent</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@userStats.WishlistItems</span>
                    <span class="stat-label">Wishlist Items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">@userStats.ReviewsGiven</span>
                    <span class="stat-label">Reviews Given</span>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="profile-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3 class="card-title">Security Settings</h3>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary" @onclick="OpenChangePasswordDialog">
                    <i class="fas fa-key"></i> Change Password
                </button>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-secondary">
                    <i class="fas fa-mobile-alt"></i> Two-Factor Authentication
                </button>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-danger" @onclick="OpenDeleteAccountDialog">
                    <i class="fas fa-trash"></i> Delete Account
                </button>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="profile-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="card-title">Recent Activity</h3>
            </div>
            <div class="recent-activity">
                @if (recentActivities != null && recentActivities.Any())
                {
                    @foreach (var activity in recentActivities)
                    {
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="@GetActivityIcon(activity.Type)"></i>
                            </div>
                            <div class="activity-content">
                                <p class="activity-text">@activity.Description</p>
                                <span class="activity-time">@activity.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p style="text-align: center; color: var(--light-text); padding: 20px;">
                        No recent activity found.
                    </p>
                }
            </div>
        </div>

        <!-- Addresses Card -->
        <div class="profile-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <h3 class="card-title">My Addresses</h3>
            </div>
            <div class="addresses-section">
                @if (userAddresses?.Any() == true)
                {
                    @foreach (var address in userAddresses)
                    {
                        <div class="address-item @(address.IsDefault == true ? "default-address" : "")">
                            <div class="address-header">
                                <div class="address-label">
                                    @if (address.IsDefault == true)
                                    {
                                        <span class="default-badge">Default</span>
                                    }
                                </div>
                                <div class="address-actions">
                                    <button class="btn btn-sm btn-outline" @onclick="() => EditAddress(address)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    @if (address.IsDefault != true)
                                    {
                                        <button class="btn btn-sm btn-outline" @onclick="() => SetDefaultAddress(address)">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    }
                                    @if (userAddresses.Count > 1)
                                    {
                                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteAddress(address)" 
                                                disabled="@(address.IsDefault == true)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                            <div class="address-content">
                                <p class="address-line1">@address.AddressLine1</p>
                                @if (!string.IsNullOrEmpty(address.AddressLine2))
                                {
                                    <p class="address-line2">@address.AddressLine2</p>
                                }
                                <p class="address-location">@address.City, @address.State @address.PostalCode</p>
                                <p class="address-country">@address.Country</p>
                            </div>
                        </div>
                    }
                    
                    <button class="btn btn-secondary" @onclick="AddNewAddress">
                        <i class="fas fa-plus"></i> Add Another Address
                    </button>
                }
                else
                {
                    <div class="no-addresses">
                        <i class="fas fa-map-marker-alt" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                        <h4>No addresses found</h4>
                        <p style="color: #666; margin-bottom: 20px;">
                            You need to add at least one address to complete your profile and make purchases.
                        </p>
                        <button class="btn btn-primary" @onclick="AddNewAddress">
                            <i class="fas fa-plus"></i> Add Your First Address
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <div style="text-align: center; padding: 50px;">
        <p>Unable to load profile information. Please try again later.</p>
        <button class="btn btn-primary" @onclick="LoadUserProfile">
            <i class="fas fa-refresh"></i> Retry
        </button>
    </div>
}


<!-- Hidden file input for avatar upload -->
<InputFile id="avatarInput" OnChange="@HandleAvatarUpload" accept="image/*" style="display: none;" />

<!-- Seller Registration Modal -->
@if (isSellerRegistrationModalOpen)
{
    <div class="modal-overlay fade-in" @onclick="CloseSellerRegistrationModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(isEditingSellerProfile ? "Edit Store Information" : "Become a Seller")</h3>
                <button class="modal-close" @onclick="CloseSellerRegistrationModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <EditForm Model="@sellerProfileModel" OnValidSubmit="@SaveSellerProfile">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="modal-body">
                    @if (!isEditingSellerProfile)
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Welcome to Seller Registration!</strong> 
                                Fill out the form below to start your journey as a seller on our platform.
                            </div>
                        </div>
                    }
                    
                    <div class="form-group">
                        <label>Store Name *</label>
                        <InputText @bind-Value="sellerProfileModel.StoreName" class="form-control" 
                                   placeholder="Enter your store name (e.g., 'TechGadgets Store')" />
                        <ValidationMessage For="@(() => sellerProfileModel.StoreName)" />
                        <small class="form-text">This will be displayed to customers as your store name.</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Store Description</label>
                        <textarea @bind="sellerProfileModel.Description" class="form-control" rows="4"
                                  placeholder="Describe your store, what you sell, your mission, etc. (optional)"></textarea>
                        <ValidationMessage For="@(() => sellerProfileModel.Description)" />
                        <small class="form-text">Help customers understand what makes your store special.</small>
                    </div>
                    
                    @if (!isEditingSellerProfile)
                    {
                        <div class="seller-terms">
                            <div class="terms-section">
                                <h5>Seller Terms & Conditions</h5>
                                <ul class="terms-list">
                                    <li>You agree to provide accurate product information</li>
                                    <li>You will fulfill orders in a timely manner</li>
                                    <li>You comply with our seller policies and guidelines</li>
                                    <li>Your account will be subject to verification</li>
                                </ul>
                            </div>
                            
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <InputCheckbox @bind-Value="acceptTerms" />
                                    I agree to the <a href="#" target="_blank">Seller Terms & Conditions</a>
                                </label>
                            </div>
                        </div>
                    }
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSellerRegistrationModal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" 
                            disabled="@(isSavingSellerProfile || (!isEditingSellerProfile && !acceptTerms))">
                        @if (isSavingSellerProfile)
                        {
                            <span class="loading-spinner"></span>
                            <text>@(isEditingSellerProfile ? "Updating..." : "Registering...")</text>
                        }
                        else if (isEditingSellerProfile)
                        {
                            <text><i class="fas fa-save"></i> Update Store Info</text>
                        }
                        else
                        {
                            <text><i class="fas fa-store"></i> Register as Seller</text>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

<!-- Address Modal -->
@if (isAddressModalOpen)
{
    <div class="modal-overlay fade-in" @onclick="CloseAddressModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(isEditingAddress ? "Edit Address" : (userAddresses.Any() ? "Add New Address" : "Add Your First Address"))</h3>
                <button class="modal-close" @onclick="CloseAddressModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <EditForm Model="@editingAddress" OnValidSubmit="@SaveAddress">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="modal-body">
                    @if (!userAddresses.Any() && !isEditingAddress)
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>First Address Setup:</strong> This will be automatically set as your default address for deliveries and billing.
                            </div>
                        </div>
                    }
                    
                    <div class="form-group">
                        <label>Address Line 1 *</label>
                        <InputText @bind-Value="editingAddress.AddressLine1" class="form-control" placeholder="Street number and name" />
                        <ValidationMessage For="@(() => editingAddress.AddressLine1)" />
                    </div>
                    
                    <div class="form-group">
                        <label>Address Line 2</label>
                        <InputText @bind-Value="editingAddress.AddressLine2" class="form-control" placeholder="Apartment, suite, building, floor, etc. (optional)" />
                        <ValidationMessage For="@(() => editingAddress.AddressLine2)" />
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>City *</label>
                            <InputText @bind-Value="editingAddress.City" class="form-control" placeholder="City name" />
                            <ValidationMessage For="@(() => editingAddress.City)" />
                        </div>
                        
                        <div class="form-group">
                            <label>State/Province</label>
                            <InputText @bind-Value="editingAddress.State" class="form-control" placeholder="State or province" />
                            <ValidationMessage For="@(() => editingAddress.State)" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Postal Code</label>
                            <InputText @bind-Value="editingAddress.PostalCode" class="form-control" placeholder="ZIP or postal code" />
                            <ValidationMessage For="@(() => editingAddress.PostalCode)" />
                        </div>
                        
                        <div class="form-group">
                            <label>Country *</label>
                            <InputText @bind-Value="editingAddress.Country" class="form-control" placeholder="Country name" />
                            <ValidationMessage For="@(() => editingAddress.Country)" />
                        </div>
                    </div>
                    
                    @if (userAddresses.Any())
                    {
                        <div class="form-group">
                            <label class="checkbox-label">
                                <InputCheckbox @bind-Value="isDefaultAddress" />
                                Set as default address
                            </label>
                        </div>
                    }
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddressModal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" disabled="@isSavingAddress">
                        @if (isSavingAddress)
                        {
                            <span class="loading-spinner"></span>
                            <text>Saving...</text>
                        }
                        else if (isEditingAddress)
                        {
                            <text>Update Address</text>
                        }
                        else if (!userAddresses.Any())
                        {
                            <text><i class="fas fa-plus"></i> Add First Address</text>
                        }
                        else
                        {
                            <text><i class="fas fa-plus"></i> Add Address</text>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}
</div>


@code {
    private ProfileVM? currentUser;
    private ProfileVM editModel = new();
    private UserStatsModel userStats = new();
    private List<ActivityModel> recentActivities = new();
    private List<AddressVM> userAddresses = new();
    private AddressVM editingAddress = new();
    
    // Seller Profile properties
    private SellerProfileVM? currentSellerProfile;
    private SellerProfileVM sellerProfileModel = new();
    private bool isSellerRegistrationModalOpen = false;
    private bool isEditingSellerProfile = false;
    private bool isSavingSellerProfile = false;
    private bool acceptTerms = false;
    
    private bool isLoading = true;
    private bool isEditing = false;
    private bool isSaving = false;
    private bool isAddressModalOpen = false;
    private bool isEditingAddress = false;
    private bool isDefaultAddress = false;
    private bool isSavingAddress = false;

    private int? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadAllData();
        await InitializeSignalRAsync();
    }

    private async Task LoadAllData()
    {
        isLoading = true;
        await Task.WhenAll(
            LoadUserProfile(),
            LoadUserAddresses(),
            LoadSellerProfile(),
            LoadUserStats(),
            LoadRecentActivity()
        );
        isLoading = false;
    }
        private async Task<int?> GetCurrentUserIdAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.Claims.FirstOrDefault(c => c.Type == "UserId");
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int userId))
            {
                return userId;
            }
        }
        return null;
    }
    private async Task LoadSellerProfile()
    {
        try
        {
            var userId = await GetCurrentUserIdAsync();
            if (userId.HasValue)
            {
                currentSellerProfile = await SellerProfileService.GetSellerProfileByUserIdAsync(userId.Value);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading seller profile: {ex.Message}");
            // Don't show error to user as not having a seller profile is normal for customers
        }
    }

    private async Task OpenSellerRegistrationModal()
    {
        try
        {
            sellerProfileModel = new SellerProfileVM();
            acceptTerms = false;
            isEditingSellerProfile = false;
            isSellerRegistrationModalOpen = true;
            StateHasChanged();
            
            await Task.Delay(50);
            await JSRuntime.InvokeVoidAsync("document.body.classList.add", "modal-open");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error opening seller registration: {ex.Message}");
        }
    }

    private async Task EditSellerProfile()
    {
        try
        {
            if (currentSellerProfile == null) return;
            
            sellerProfileModel = new SellerProfileVM
            {
                SellerId = currentSellerProfile.SellerId,
                UserId = currentSellerProfile.UserId,
                StoreName = currentSellerProfile.StoreName,
                Description = currentSellerProfile.Description,
                IsVerified = currentSellerProfile.IsVerified,
                CreatedAt = currentSellerProfile.CreatedAt,
                UpdatedAt = currentSellerProfile.UpdatedAt
            };
            
            isEditingSellerProfile = true;
            isSellerRegistrationModalOpen = true;
            StateHasChanged();
            
            await Task.Delay(50);
            await JSRuntime.InvokeVoidAsync("document.body.classList.add", "modal-open");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error opening seller profile editor: {ex.Message}");
        }
    }

    private async Task SaveSellerProfile()
    {
        try
        {
            isSavingSellerProfile = true;
            StateHasChanged();
            
            // üî• TH√äM: Ki·ªÉm tra connection tr∆∞·ªõc khi save
            await EnsureSignalRConnectionAsync();
            
            var userId = await GetCurrentUserIdAsync();
            if (!userId.HasValue)
            {
                ToastService.ShowError("User ID not found. Please login again.");
                return;
            }

            sellerProfileModel.UserId = userId.Value;
            sellerProfileModel.UpdatedAt = DateTime.Now;
            
            bool success = false;
            
            if (isEditingSellerProfile)
            {
                // Update existing seller profile
                Console.WriteLine($"üîî Profile.razor updating seller: SellerId={sellerProfileModel.SellerId}");
                
                success = await SellerProfileService.UpdateSellerProfileAsync(sellerProfileModel);
                if (success)
                {
                    ToastService.ShowSuccess("Store information updated successfully!");
                    currentSellerProfile = sellerProfileModel;
                    
                    // üî• IMPROVED: ƒê·∫£m b·∫£o connection v√† g·ª≠i notification
                    await EnsureSignalRConnectionAndNotify(async () =>
                    {
                        await SignalRService.NotifySellerProfileUpdatedAsync(
                            sellerProfileModel.SellerId, 
                            sellerProfileModel.StoreName);
                    });
                }
            }
            else
            {
                // Create new seller profile
                success = await SellerProfileService.CreateSellerProfileAsync(sellerProfileModel);
                if (success)
                {
                    ToastService.ShowSuccess("Seller registration submitted successfully!");
                    currentSellerProfile = sellerProfileModel;
                    
                    // üî• IMPROVED: ƒê·∫£m b·∫£o connection v√† g·ª≠i notification
                    await EnsureSignalRConnectionAndNotify(async () =>
                    {
                        await SignalRService.NotifySellerProfileCreatedAsync(sellerProfileModel.StoreName);
                    });
                }
                else
                {
                    ToastService.ShowError("Failed to register as a seller Store Name. Please try again.");
                }
            }
                await CloseSellerRegistrationModal();

        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error saving seller profile: {ex.Message}");
            ToastService.ShowError($"Error saving seller profile: {ex.Message}");
        }
        finally
        {
            isSavingSellerProfile = false;
            StateHasChanged();
        }
    }

    // üî• TH√äM: Method ƒë·ªÉ ƒë·∫£m b·∫£o SignalR connection
    private async Task EnsureSignalRConnectionAsync()
    {
        try
        {
            if (!SignalRService.IsConnected)
            {
                Console.WriteLine("üîÑ SignalR not connected, attempting to reconnect...");
                await SignalRService.StartConnectionAsync();
                
                // Re-register user connection
                if (currentUserId.HasValue)
                {
                    await SignalRService.RegisterUserConnectionAsync(currentUserId.Value.ToString());
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Failed to ensure SignalR connection: {ex.Message}");
        }
    }

    // üî• TH√äM: Method ƒë·ªÉ ƒë·∫£m b·∫£o connection v√† g·ª≠i notification
    private async Task EnsureSignalRConnectionAndNotify(Func<Task> notificationAction)
    {
        try
        {
            // Ki·ªÉm tra v√† ƒë·∫£m b·∫£o connection
            await EnsureSignalRConnectionAsync();
            
            // Delay ƒë·ªÉ ƒë·∫£m b·∫£o database update ho√†n t·∫•t
            await Task.Delay(500);
            
            // G·ª≠i notification
            await notificationAction();
            
            Console.WriteLine("‚úÖ SignalR notification sent successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå SignalR notification failed: {ex.Message}");
            
            // Retry m·ªôt l·∫ßn n·ªØa
            try
            {
                await Task.Delay(1000);
                await EnsureSignalRConnectionAsync();
                await notificationAction();
                Console.WriteLine("‚úÖ SignalR notification retry successful");
            }
            catch (Exception retryEx)
            {
                Console.WriteLine($"‚ùå SignalR notification retry failed: {retryEx.Message}");
            }
        }
    }

    private async Task CloseSellerRegistrationModal()
    {
        try
        {
            isSellerRegistrationModalOpen = false;
            await JSRuntime.InvokeVoidAsync("document.body.classList.remove", "modal-open");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing seller registration modal: {ex.Message}");
        }
    }

    private async Task InitializeSignalRAsync()
{
    try
    {
        currentUserId = await GetCurrentUserIdAsync();
        
        // Subscribe to SignalR events for Address
        SignalRService.AddressCreated += OnAddressCreated;
        SignalRService.AddressUpdated += OnAddressUpdated;
        SignalRService.AddressDeleted += OnAddressDeleted;
        SignalRService.DefaultAddressChanged += OnDefaultAddressChanged;

        // Subscribe to Seller Profile events
        SignalRService.SellerProfileCreated += OnSellerProfileCreated;
        SignalRService.SellerProfileUpdated += OnSellerProfileUpdated;
        SignalRService.SellerProfileDeleted += OnSellerProfileDeleted;
        SignalRService.SellerProfileVerified += OnSellerProfileVerified;
        SignalRService.SellerProfileUnverified += OnSellerProfileUnverified;

        // üî• TH√äM: Subscribe to User events ƒë·ªÉ bi·∫øt khi th√¥ng tin user thay ƒë·ªïi
        SignalRService.UserUpdated += OnUserUpdated;
        SignalRService.UserStatusChanged += OnUserStatusChanged;

        // Start connection if not already connected
        if (!SignalRService.IsConnected)
        {
            await SignalRService.StartConnectionAsync();
        }

        // Register user connection for receiving targeted notifications
        if (currentUserId.HasValue)
        {
            await SignalRService.RegisterUserConnectionAsync(currentUserId.Value.ToString());
        }
        
        Console.WriteLine("‚úÖ Profile.razor SignalR initialized successfully");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"‚ùå Error initializing SignalR: {ex.Message}");
    }
}
private async void OnUserUpdated(int userId, string username)
{
    try
    {
        if (currentUserId.HasValue && currentUserId.Value == userId)
        {
            Console.WriteLine($"üîî Profile.razor received UserUpdated: UserId={userId}, Username={username}");
            
            await InvokeAsync(async () =>
            {
                // Reload user data ƒë·ªÉ c√≥ th√¥ng tin m·ªõi nh·∫•t t·ª´ server
                await LoadUserProfile();
                ToastService.ShowInfo("Your account information has been updated by admin");
                
                // Add activity
                recentActivities.Insert(0, new ActivityModel
                {
                    Type = "account",
                    Description = "Account information updated by admin",
                    CreatedAt = DateTime.Now
                });
                
                StateHasChanged();
            });
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"‚ùå Error in OnUserUpdated: {ex.Message}");
    }
}

private async void OnUserStatusChanged(int userId, string status)
{
    try
    {
        if (currentUserId.HasValue && currentUserId.Value == userId)
        {
            Console.WriteLine($"üîî Profile.razor received UserStatusChanged: UserId={userId}, Status={status}");
            
            await InvokeAsync(async () =>
            {
                // Reload user data ƒë·ªÉ c√≥ status m·ªõi
                await LoadUserProfile();
                
                var message = status == "Active" ? "Your account has been activated" : "Your account has been deactivated";
                ToastService.ShowInfo(message);
                
                // Add activity
                recentActivities.Insert(0, new ActivityModel
                {
                    Type = "account",
                    Description = $"Account status changed to {status}",
                    CreatedAt = DateTime.Now
                });
                
                StateHasChanged();
            });
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"‚ùå Error in OnUserStatusChanged: {ex.Message}");
    }
}

    // üî• TH√äM: Seller Profile SignalR Event Handlers
    private async void OnSellerProfileCreated(string storeName)
    {
        try
        {
            Console.WriteLine($"üîî Received seller profile created event: {storeName}");
            
            // üî• IMPROVED: Lu√¥n reload ƒë·ªÉ check xem user hi·ªán t·∫°i c√≥ t·∫°o seller profile kh√¥ng
            await InvokeAsync(async () =>
            {
                var previousProfile = currentSellerProfile;
                await LoadSellerProfile();
                
                // Ch·ªâ show notification n·∫øu profile m·ªõi ƒë∆∞·ª£c t·∫°o cho user n√†y
                if (previousProfile == null && currentSellerProfile != null)
                {
                    ToastService.ShowSuccess($"üéâ Welcome to selling! Your store '{storeName}' has been created!");
                }
                
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error in OnSellerProfileCreated: {ex.Message}");
        }
    }

    private async void OnSellerProfileUpdated(int sellerId, string storeName)
    {
        try
        {
            if (currentSellerProfile != null && currentSellerProfile.SellerId == sellerId)
            {
                Console.WriteLine($"üîî Received seller profile updated event: {sellerId} - {storeName}");
                
                await InvokeAsync(async () =>
                {
                    // üî• IMPROVED: Reload seller profile t·ª´ server ƒë·ªÉ ƒë·∫£m b·∫£o data consistency
                    await LoadSellerProfile();
                    ToastService.ShowInfo($"Your store '{storeName}' information was updated");
                    StateHasChanged();
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error in OnSellerProfileUpdated: {ex.Message}");
        }
    }

    private async void OnSellerProfileDeleted(int sellerId)
    {
        if (currentSellerProfile != null && currentSellerProfile.SellerId == sellerId)
        {
            await InvokeAsync(() =>
            {
                currentSellerProfile = null; // Clear seller profile
                ToastService.ShowWarning("Your seller profile has been deleted by admin");
                
                // Add activity
                recentActivities.Insert(0, new ActivityModel
                {
                    Type = "seller",
                    Description = "Seller profile was deleted by admin",
                    CreatedAt = DateTime.Now
                });
                
                StateHasChanged();
                return Task.CompletedTask;
            });
        }
    }

    private async void OnSellerProfileVerified(int sellerId, string storeName)
    {
        if (currentSellerProfile != null && currentSellerProfile.SellerId == sellerId)
        {
            await InvokeAsync(() =>
            {
                if (currentSellerProfile != null)
                {
                    currentSellerProfile.IsVerified = true; // Update verification status
                }
                
                ToastService.ShowSuccess($"üéâ Congratulations! Your store '{storeName}' has been verified!");
                
                // Add activity
                recentActivities.Insert(0, new ActivityModel
                {
                    Type = "seller",
                    Description = "Seller profile was verified",
                    CreatedAt = DateTime.Now
                });
                
                StateHasChanged();
                return Task.CompletedTask;
            });
        }
    }

    private async void OnSellerProfileUnverified(int sellerId, string storeName)
    {
        if (currentSellerProfile != null && currentSellerProfile.SellerId == sellerId)
        {
            await InvokeAsync(() =>
            {
                if (currentSellerProfile != null)
                {
                    currentSellerProfile.IsVerified = false; // Update verification status
                }
                
                ToastService.ShowWarning($"Your store '{storeName}' verification has been revoked by admin");
                
                // Add activity
                recentActivities.Insert(0, new ActivityModel
                {
                    Type = "seller",
                    Description = "Seller verification was revoked",
                    CreatedAt = DateTime.Now
                });
                
                StateHasChanged();
                return Task.CompletedTask;
            });
        }
    }

    private async void OnAddressCreated(int userId, string addressInfo)
    {
        if (currentUserId.HasValue && currentUserId.Value == userId)
        {
            await InvokeAsync(async () =>
            {
                await LoadUserAddresses();
                ToastService.ShowInfo($"New address added: {addressInfo}");
                StateHasChanged();
            });
        }
    }

    private async void OnAddressUpdated(int userId, string addressInfo)
    {
        if (currentUserId.HasValue && currentUserId.Value == userId)
        {
            await InvokeAsync(async () =>
            {
                await LoadUserAddresses();
                ToastService.ShowInfo($"Address updated: {addressInfo}");
                StateHasChanged();
            });
        }
    }

    private async void OnAddressDeleted(int addressId)
    {
        await InvokeAsync(async () =>
        {
            var deletedAddress = userAddresses.FirstOrDefault(a => a.AddressId == addressId);
            if (deletedAddress != null)
            {
                userAddresses.Remove(deletedAddress);
                ToastService.ShowInfo("One of your addresses was deleted by admin");
                StateHasChanged();
            }
        });
    }

    private async void OnDefaultAddressChanged(int userId, int addressId)
    {
        if (currentUserId.HasValue && currentUserId.Value == userId)
        {
            await InvokeAsync(() =>
            {
                foreach (var addr in userAddresses)
                {
                    addr.IsDefault = addr.AddressId == addressId;
                }
                ToastService.ShowInfo("Your default address was changed by admin");
                StateHasChanged();
                return Task.CompletedTask;
            });
        }
    }

    private async Task LoadUserProfile()
    {
        try
        {
            var userId = await GetCurrentUserIdAsync();
            if (!userId.HasValue)
            {
                ToastService.ShowError("User ID not found. Please login again.");
                return;
            }

            currentUser = await UserService.GetProfileAsync(userId.Value);
            if (currentUser != null)
            {
                editModel = new ProfileVM
                {
                    FirstName = currentUser.FirstName,
                    LastName = currentUser.LastName,
                    UserName = currentUser.UserName,
                    Email = currentUser.Email,
                    PhoneNumber = currentUser.PhoneNumber
                };
            }
            else
            {
                ToastService.ShowError("Profile data is null from server");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading profile: {ex.Message}");
            // Fallback logic for testing
            await TryLoadFallbackUser();
        }
    }

    private async Task TryLoadFallbackUser()
    {
        try
        {
            var allUsers = await UserService.GetAllUserAsync();
            var firstUser = allUsers?.FirstOrDefault();
            
            if (firstUser != null)
            {
                currentUser = await UserService.GetProfileAsync(firstUser.Id);
                if (currentUser != null)
                {
                    editModel = new ProfileVM
                    {
                        FirstName = currentUser.FirstName,
                        LastName = currentUser.LastName,
                        UserName = currentUser.UserName,
                        Email = currentUser.Email,
                        PhoneNumber = currentUser.PhoneNumber
                    };
                    ToastService.ShowWarning($"Using fallback user profile: {currentUser.UserName}");
                }
            }
        }
        catch
        {
            ToastService.ShowError("Unable to load any user profile");
        }
    }

    private async Task LoadUserAddresses()
    {
        try
        {
            var userId = await GetCurrentUserIdAsync();
            if (userId.HasValue)
            {
                var addresses = await AddressService.GetAddressesByUserIdAsync(userId.Value);
                userAddresses = addresses?.ToList() ?? new List<AddressVM>();
            }
        }
        catch
        {
            userAddresses = new List<AddressVM>();
        }
    }

    private async Task LoadUserStats()
    {
        // Mock data for now
        userStats = new UserStatsModel
        {
            TotalOrders = 15,
            TotalSpent = 1250.50m,
            WishlistItems = 8,
            ReviewsGiven = 12
        };
    }

    private async Task LoadRecentActivity()
    {
        // Mock data for now
        recentActivities = new List<ActivityModel>
        {
            new() { Type = "order", Description = "Placed order #ORD-2024-001", CreatedAt = DateTime.Now.AddDays(-1) },
            new() { Type = "review", Description = "Left a review for 'iPhone 15 Pro'", CreatedAt = DateTime.Now.AddDays(-3) },
            new() { Type = "wishlist", Description = "Added 'MacBook Air M2' to wishlist", CreatedAt = DateTime.Now.AddDays(-5) },
            new() { Type = "profile", Description = "Updated profile information", CreatedAt = DateTime.Now.AddDays(-7) }
        };
    }

    private void StartEdit() => isEditing = true;

    private void CancelEdit()
    {
        isEditing = false;
        if (currentUser != null)
        {
            editModel.FirstName = currentUser.FirstName;
            editModel.LastName = currentUser.LastName;
            editModel.PhoneNumber = currentUser.PhoneNumber;
        }
    }

    private async Task UpdateProfile()
{
    if (currentUser == null) return;

    try
    {
        isSaving = true;
        
        // üî• TH√äM: Ki·ªÉm tra SignalR connection tr∆∞·ªõc khi update
        await EnsureSignalRConnectionAsync();
        
        var success = await UserService.UpdateProfileAsync(editModel);
        
        if (success)
        {
            // Update local data
            currentUser.FirstName = editModel.FirstName;
            currentUser.LastName = editModel.LastName;
            currentUser.PhoneNumber = editModel.PhoneNumber;
            
            isEditing = false;
            ToastService.ShowSuccess("Profile updated successfully!");
            
            // üî• TH√äM: G·ª≠i SignalR notification sau khi update th√†nh c√¥ng
            await EnsureSignalRConnectionAndNotify(async () =>
            {
                var fullName = GetFullName(currentUser);
                var userId = await GetCurrentUserIdAsync();
                if (userId.HasValue)
                {
                    await SignalRService.NotifyUserUpdatedAsync(userId.Value, fullName);
                    Console.WriteLine($"üîî Profile.razor sent user update notification: UserId={userId.Value}, Name={fullName}");
                }
            });
            
            // Add activity
            recentActivities.Insert(0, new ActivityModel
            {
                Type = "profile",
                Description = "Updated profile information",
                CreatedAt = DateTime.Now
            });
        }
        else
        {
            ToastService.ShowError("Failed to update profile. Please try again.");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"‚ùå Error updating profile: {ex.Message}");
        ToastService.ShowError($"Error updating profile: {ex.Message}");
    }
    finally
    {
        isSaving = false;
    }
}


    private async Task SaveAddress()
    {
        try
        {
            isSavingAddress = true;
            StateHasChanged();
            
            var userId = await GetCurrentUserIdAsync();
            if (!userId.HasValue)
            {
                ToastService.ShowError("User ID not found. Please login again.");
                return;
            }

            editingAddress.UserId = userId.Value;
            
            var validationErrors = ValidateAddress(editingAddress);
            if (validationErrors.Any())
            {
                ToastService.ShowError(string.Join(", ", validationErrors));
                return;
            }
            
            if (!userAddresses.Any()) editingAddress.IsDefault = true;
            else editingAddress.IsDefault = isDefaultAddress;
            
            bool success = isEditingAddress 
                ? await AddressService.UpdateAddressAsync(editingAddress)
                : await AddressService.CreateAddressAsync(editingAddress);
            
            if (success)
            {
                var message = isEditingAddress ? "Address updated successfully!" 
                    : (!userAddresses.Any() ? "Your first address has been added and set as default!" 
                        : "New address added successfully!");
                ToastService.ShowSuccess(message);
                
                // Send SignalR notification for address creation/update
                _ = Task.Run(async () =>
                {
                    try
                    {
                        var addressInfo = $"{editingAddress.AddressLine1}, {editingAddress.City}";
                        if (isEditingAddress)
                        {
                            await SignalRService.NotifyAddressUpdatedAsync(userId.Value, addressInfo);
                        }
                        else
                        {
                            await SignalRService.NotifyAddressCreatedAsync(userId.Value, addressInfo);
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"SignalR notification failed: {ex.Message}");
                    }
                });
                
                await LoadUserAddresses();
                await CloseAddressModal();
            }
            else
            {
                ToastService.ShowError("Failed to save address. Please try again.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving address: {ex.Message}");
        }
        finally
        {
            isSavingAddress = false;
            StateHasChanged();
        }
    }

    private async Task SetDefaultAddress(AddressVM address)
    {
        try
        {
            var success = await AddressService.SetDefaultAddressAsync(address.AddressId, address.UserId);
            if (success)
            {
                foreach (var addr in userAddresses)
                {
                    addr.IsDefault = addr.AddressId == address.AddressId;
                }
                ToastService.ShowSuccess("Default address updated!");
                
                // Send SignalR notification for default address change
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await SignalRService.NotifyDefaultAddressChangedAsync(address.UserId, address.AddressId);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"SignalR notification failed: {ex.Message}");
                    }
                });
            }
            else
            {
                ToastService.ShowError("Failed to set default address.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error setting default address: {ex.Message}");
        }
    }

    private async Task DeleteAddress(AddressVM address)
    {
        try
        {
            if (address.IsDefault == true)
            {
                ToastService.ShowWarning("Cannot delete default address. Please set another address as default first.");
                return;
            }
            
            if (userAddresses.Count <= 1)
            {
                ToastService.ShowWarning("You must have at least one address. Cannot delete your only address.");
                return;
            }
            
            var success = await AddressService.DeleteAddressAsync(address.AddressId);
            if (success)
            {
                userAddresses.Remove(address);
                StateHasChanged();
                ToastService.ShowSuccess("Address deleted successfully!");
                
                // Send SignalR notification for address deletion
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await SignalRService.NotifyAddressDeletedAsync(address.AddressId);
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"SignalR notification failed: {ex.Message}");
                    }
                });
            }
            else
            {
                ToastService.ShowError("Failed to delete address.");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting address: {ex.Message}");
        }
    }

    private List<string> ValidateAddress(AddressVM address)
    {
        var errors = new List<string>();
        
        if (string.IsNullOrWhiteSpace(address.AddressLine1))
            errors.Add("Address Line 1 is required");
        if (string.IsNullOrWhiteSpace(address.City))
            errors.Add("City is required");
        if (string.IsNullOrWhiteSpace(address.Country))
            errors.Add("Country is required");
            
        return errors;
    }

    private async Task AddNewAddress()
    {
        try
        {
            Console.WriteLine("AddNewAddress clicked"); // Debug log
            editingAddress = new AddressVM();
            isDefaultAddress = !userAddresses.Any();
            isEditingAddress = false;
            await OpenAddressModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in AddNewAddress: {ex.Message}");
            ToastService.ShowError($"Error opening address form: {ex.Message}");
        }
    }

    private async Task EditAddress(AddressVM address)
    {
        try
        {
            Console.WriteLine("EditAddress clicked"); // Debug log
            editingAddress = new AddressVM
            {
                AddressId = address.AddressId,
                UserId = address.UserId,
                AddressLine1 = address.AddressLine1,
                AddressLine2 = address.AddressLine2,
                City = address.City,
                State = address.State,
                PostalCode = address.PostalCode,
                Country = address.Country,
                IsDefault = address.IsDefault
            };
            isDefaultAddress = address.IsDefault ?? false;
            isEditingAddress = true;
            await OpenAddressModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in EditAddress: {ex.Message}");
            ToastService.ShowError($"Error opening address form: {ex.Message}");
        }
    }

    private async Task OpenAddressModal()
    {
        try
        {
            Console.WriteLine("OpenAddressModal called"); // Debug log
            isAddressModalOpen = true;
            StateHasChanged(); // Force UI update first
            
            // Add delay to ensure UI is rendered
            await Task.Delay(50);
            
            await JSRuntime.InvokeVoidAsync("document.body.classList.add", "modal-open");
            Console.WriteLine("Modal should be open now"); // Debug log
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in OpenAddressModal: {ex.Message}");
            ToastService.ShowError($"Error opening modal: {ex.Message}");
        }
    }

    private async Task CloseAddressModal()
    {
        try
        {
            Console.WriteLine("CloseAddressModal called"); // Debug log
            isAddressModalOpen = false;
            await JSRuntime.InvokeVoidAsync("document.body.classList.remove", "modal-open");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in CloseAddressModal: {ex.Message}");
        }
    }

    private async Task OpenAvatarUpload() => await JSRuntime.InvokeVoidAsync("document.getElementById('avatarInput').click");

    private async Task HandleAvatarUpload(InputFileChangeEventArgs e) => ToastService.ShowInfo("Avatar upload feature will be implemented soon!");

    private async Task OpenChangePasswordDialog() => ToastService.ShowInfo("Change password feature will be implemented soon!");

    private async Task OpenDeleteAccountDialog() => ToastService.ShowWarning("Delete account feature will be implemented soon!");

    private string GetFullName(ProfileVM user) => 
        string.IsNullOrWhiteSpace(user.FirstName) && string.IsNullOrWhiteSpace(user.LastName) 
            ? user.UserName ?? "Unknown User" 
            : $"{user.FirstName?.Trim()} {user.LastName?.Trim()}".Trim();

    private string GetInitials(ProfileVM user)
    {
        string fn = user.FirstName?.Trim() ?? "";
        string ln = user.LastName?.Trim() ?? "";

        if (string.IsNullOrEmpty(fn) && string.IsNullOrEmpty(ln))
            return (user.UserName?.Trim() ?? "").Length > 0 ? user.UserName[0].ToString().ToUpper() : "?";

        if (string.IsNullOrEmpty(ln))
            return fn.Length > 0 ? fn[0].ToString().ToUpper() : "?";

        if (string.IsNullOrEmpty(fn))
            return ln.Length > 0 ? ln[0].ToString().ToUpper() : "?";

        return $"{fn[0]}{ln[0]}".ToUpper();
    }

    private string GetActivityIcon(string type) => type switch
    {
        "order" => "fas fa-shopping-cart",
        "review" => "fas fa-star",
        "wishlist" => "fas fa-heart",
        "profile" => "fas fa-user-edit",
        "seller" => "fas fa-store",
        _ => "fas fa-clock"
    };

    public class UserStatsModel
    {
        public int TotalOrders { get; set; }
        public decimal TotalSpent { get; set; }
        public int WishlistItems { get; set; }
        public int ReviewsGiven { get; set; }
    }

    public class ActivityModel
    {
        public string Type { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime CreatedAt { get; set; }
    }

    public void Dispose()
    {
        // Unsubscribe from SignalR events
        SignalRService.AddressCreated -= OnAddressCreated;
        SignalRService.AddressUpdated -= OnAddressUpdated;
        SignalRService.AddressDeleted -= OnAddressDeleted;
        SignalRService.DefaultAddressChanged -= OnDefaultAddressChanged;
        
        // üî• TH√äM: Unsubscribe Seller Profile events
        SignalRService.SellerProfileCreated -= OnSellerProfileCreated;
        SignalRService.SellerProfileUpdated -= OnSellerProfileUpdated;
        SignalRService.SellerProfileDeleted -= OnSellerProfileDeleted;
        SignalRService.SellerProfileVerified -= OnSellerProfileVerified;
        SignalRService.SellerProfileUnverified -= OnSellerProfileUnverified;
        // üî• TH√äM: Unsubscribe User events
    SignalRService.UserUpdated -= OnUserUpdated;
    SignalRService.UserStatusChanged -= OnUserStatusChanged;
    }

    // ...rest of existing code...
}

